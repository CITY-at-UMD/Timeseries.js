!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("data-forge"),require("dayjs"),require("lodash/isEqual"),require("lodash/has"),require("lodash/fromPairs"),require("lodash/toPairs"),require("simple-statistics"),require("distributions")):"function"==typeof define&&define.amd?define(["data-forge","dayjs","lodash/isEqual","lodash/has","lodash/fromPairs","lodash/toPairs","simple-statistics","distributions"],t):(e=e||self).timeseries=t(e.dataForge,e.dayjs,e.isEqual,e.has,e.fromPairs,e.toPairs,e.simpleStatistics,e.distributions)}(this,(function(e,t,r,n,a,i,u,o){function f(){return(f=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(this,arguments)}function l(e,t){if(null==e)return{};var r,n,a={},i=Object.keys(e);for(n=0;n<i.length;n++)t.indexOf(r=i[n])>=0||(a[r]=e[r]);return a}t=t&&t.hasOwnProperty("default")?t.default:t,r=r&&r.hasOwnProperty("default")?r.default:r,n=n&&n.hasOwnProperty("default")?n.default:n,a=a&&a.hasOwnProperty("default")?a.default:a,i=i&&i.hasOwnProperty("default")?i.default:i;var s=function(e,t,r){var n,u=t.startValue,o=t.endValue,l=t.entryIndex,s=t.numEntries,d=r.overrideValue,c=r.dateFunction,h=r.date,v=r.flag;if(-1===["pad","interpolate","average","dateFunction","value"].indexOf(e))throw new Error("fill Type not supported");return"pad"===e?(n=a(i(u).map((function(e){var t=e[0];return[t,u[t]]}))),v=v||["fill","pad"]):"interpolate"===e?(n=a(i(u).map((function(e){var t=e[0];return[t,u[t]+(l+1)*((o[t]-u[t])/(s+1))]}))),v=v||["fill",e]):"average"===e?(n=a(i(u).map((function(e){var t=e[0];return[t,(u[t]+o[t])/s]}))),v=v||["fill",e]):"dateFunction"===e&&c?(n=a(i(u).map((function(e){return[e[0],c(h)]}))),v=v||["fill",e]):"value"===e?(n=a(i(u).map((function(e){var t=e[0];return[t,"number"==typeof d?d:d[t]]}))),v=v||["fill",e]):(n=a(i(u).map((function(e){return[e[0],null]}))),v=["fill"]),f({},n,{flag:v})};function d(t){var r=t.deflate((function(e){return e.x})).toArray(),n=u.sampleStandardDeviation(r),a=u.mean(r);if(0===n){var i=t.generateSeries({ares:function(e){return 0}});return{R:0,std:n,mean:a,df:i}}var o=new e.DataFrame({values:r.map((function(e){return{x:e,ares:Math.abs(e-a)/n}}))});return{R:u.max(o.deflate((function(e){return e.ares})).toArray()),df:o,std:n,mean:a}}function c(e,t,r){var n=function(e,t,r){return 1-r/(2*(e-t+1))}(e,t,r),a=function(e,t){return new o.Studentt(t).inv(e)}(n,e-t-1);return{lambda:a*(e-t)/Math.sqrt((e-t-1+Math.pow(a,2))*(e-t+1)),p:n,t:a}}var h=function(e,t,r){return.6745*(e-r)/t};function v(e){var t=u.median(e),r=u.medianAbsoluteDeviation(e),n=(e=e.sort((function(e,t){return t-e})).filter((function(e){return e>0})).map((function(e){return[e,h(e,r,t)]}))).filter((function(e){return Math.abs(e[1])>=3.5}));return{thresholds:{upper:Math.min.apply(Math,[Infinity].concat(n.map((function(e){return e[0]})))),lower:0}}}return function(i){var o,h;function m(r){if(void 0===r&&(r=[]),r instanceof m)return r||function(e){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}();r instanceof e.DataFrame&&(r=r.toArray());var n={values:r=r.map((function(e){var r=e.date,n=l(e,["date"]);return f({date:t(r)},n)})).sort((function(e,t){return e.date.valueOf()-t.date.valueOf()})),index:r.map((function(e){return e.date.toDate()})),considerAllRows:!0};return i.call(this,n)||this}h=i,(o=m).prototype=Object.create(h.prototype),o.prototype.constructor=o,o.__proto__=h;var p,y=m.prototype;return y.dateRange=function(e,r){var n=t(this.first().date),a=t(this.last().date);return r&&(n=n.startOf(r),a=a.endOf(r)),a.diff(n,e)},y.at=function(e){return i.prototype.at.call(this,t(e))},y.calculateThresholds=function(t){var r,n,a,i,o=void 0===t?{}:t,f=o.k,l=o.filterZeros,s=void 0===l||l,h=o.filterNegative,m=void 0===h||h,p=this.where((function(e){return null==e.flag||Array.isArray(e.flag)&&0===e.flag.length})).where((function(e){return!isNaN(e.value)&&null!==e.value})).getSeries("value");return s&&(p=p.where((function(e){return 0!==e}))),m&&(p=p.where((function(e){return e>0}))),f||(f=p.count()<1e3?Math.floor(.15*p.count()):Math.min.apply(Math,[1e3,Math.floor(.02*p.count())])),p.count()<5?{}:{esd:function(t,r,n){void 0===t&&(t=[]),void 0===r&&(r=10),void 0===n&&(n=.05);for(var a,i=new e.DataFrame({values:t.map((function(e){return{x:e}}))}),u=i.getSeries("x").count(),o=1,f=[],l=!1;o<=r;){var s={};1===o?function(){var e=d(i),t=e.R,r=e.df,n=e.mean,u=e.std;a=r.where((function(e){return e.ares!==t})),s=Object.assign({},s,{mean:n,std:u,Value:r.where((function(e){return e.ares===t})).getSeries("x").first(),R:t})}():function(){var e=d(a),t=e.R,r=e.df,n=e.mean,i=e.std;a=r.where((function(e){return e.ares!==t})),s=Object.assign({},s,{mean:n,std:i,Value:r.where((function(e){return e.ares===t})).getSeries("x").first(),R:t})}();var h=c(u,o,n);if(s=Object.assign({},s,{lambda:h.lambda}),f.push(s),l&&s.R>s.lambda&&(l=!1),0===s.R)break;if(s.R<s.lambda){if(l)break;l=!0}o++}var v=(f=new e.DataFrame(f).generateSeries({outlier:function(e){return e.R>e.lambda}}).takeWhile((function(e){return e.outlier}))).where((function(e){return e.Value>0})).deflate((function(e){return e.Value}));return{outliers:f,thresholds:{lower:0,upper:v.count()>0?v.min():Infinity},iterations:o}}(p.toArray(),f).thresholds,box:(r=p.toArray(),n=u.quantile(r,.25),a=u.quantile(r,.75),{thresholds:{lowerInner:n-1.5*(i=a-n),upperInner:n-3*i,lowerOuter:a+1.5*i,upperOuter:a+3*i}}).thresholds,modz:v(p.toArray()).thresholds}},y.calculateStatistics=function(e){var t=void 0===e?{}:e,r=t.column,n=void 0===r?"value":r,a=t.filterZeros,i=void 0!==a&&a,o=t.filterNegative,f=void 0===o||o,l=this.deflate((function(e){return e[n]})).where((function(e){return!isNaN(e)}));f&&(l=l.where((function(e){return e>=0}))),i&&(l=l.where((function(e){return 0!==e})));var s=l.median(),d=l.average(),c=l.count(),h=l.std(),v=l.min(),m=l.max(),p=u.medianAbsoluteDeviation(l.toArray()),y=u.quantile(l.toArray(),.25),w=u.quantile(l.toArray(),.75);return{median:s,mean:d,count:c,std:h,min:v,max:m,mad:p,q1:y,q3:w,iqr:w-y}},y.dataQuality=function(){return this.count(),this.getSeries("flag").where((function(e){return null==e||Array.isArray(e)&&0===e.length})).count(),this.getSeries("flag").where((function(e){return Array.isArray(e)})).where((function(e){return-1!==e.indexOf("missing")})).count(),this.getSeries("flag").where((function(e){return Array.isArray(e)})).where((function(e){return-1!==e.indexOf("outlier")})).count(),this.getSeries("flag").where((function(e){return Array.isArray(e)})).where((function(e){return-1!==e.indexOf("zeroFill")})).count(),{}},y.transformAll=function(e,t){void 0===e&&(e=function(e){return e});var r=this;return t||(t=r.detectTypes().where((function(e){return"number"===e.Type})).distinct((function(e){return e.Column})).getSeries("Column").toArray()),t.forEach((function(t){var n;r=r.transformSeries(((n={})[t]=function(t){return isNaN(t)?t:e(t)},n))})),new m(r)},y.removeOutliers=function(e){var t=void 0===e?{}:e,r=t.lowerThreshold,n=t.upperThreshold;if(r>n)throw new Error("thresholds invalid");var a=function(e,t,r){return e<t||e>r};return new m(this.generateSeries({raw:function(e){return a(e.value,r,n)?e.value:null},flag:function(e){return a(e.value,r,n)?["outlier"]:null}}).transformSeries({value:function(e){return a(e,r,n)?null:e}}))},y.reset=function(){return this.withSeries({value:function(e){return e.raw&&!isNaN(e.raw)?e.raw:e.value}}).dropSeries(["flag","raw"])},y.group=function(e,r){if(-1===["hour","day","month","year"].indexOf(e))throw new Error("interval type not supported");return this.groupBy((function(r){return t(r.date).startOf(e)}))},y.resample=function(e,n){var a=e[0],i=e[1],u=void 0===i?1:i;if(-1===["hour","day","month","year"].indexOf(a))throw new Error("interval type not supported");var o=this.interval;if(r(o,[a,u]))return this;var f=t(0);return t(0).add(o[1],o[0]).diff(f)<t(0).add(u,a).diff(f)?this.downsample([a,u],n):this.upsample([a,u],n)},y.upsample=function(e,r){var n=e[0],a=e[1];return void 0===r&&(r="avg"),new m(this.fillGaps(function(e){var r=e[0],n=e[1],a=void 0===n?1:n;return function(e,n){var i=e[0];return Math.floor(t(n[0]).diff(i,r,!0)/a)>0}}([n,a]),function(e,r,n){var a=r[0],i=r[1],u={},o=u.overrideValue,f=u.dateFunction,l=u.flag;return function(r,n){for(var u=t(r[0]),d=t(n[0]),c=Math.floor(t(d).diff(u,a)/i)-1,h=r[1],v=n[1],m=[],p=0;p<c;++p){var y=s(e,{startValue:h,endValue:v,entryIndex:p,numEntries:c},{overrideValue:o,dateFunction:f,flag:l}),w=t(u).add((p+1)*i,a).toDate(),g=[w.valueOf(),Object.assign({},y,{date:w})];m.push(g)}return m}}(r,[n,a])))},y.downsample=function(e,r){var n=e[0],i=e[1];if(void 0===r&&(r="sum"),-1===["hour","day","month","year"].indexOf(n))throw new Error("interval type not supported");if(-1===["sum","avg","median"].indexOf(r))throw new Error("aggregation type not suppported, only:");var u=function(e){return e.date.startOf(n)},o=this.valueColumns;return i&&(u=function(e){return e.date.startOf(n).add(i,n)}),new m(this.groupBy(u).select((function(e){return f({date:e.first().date.startOf(n)},a([].concat(o.map((function(t){var n;switch(r){case"median":n=e.deflate((function(e){return e[t]})).where((function(e){return e})).median();break;case"avg":n=e.deflate((function(e){return e[t]})).where((function(e){return e})).average();break;default:n=e.deflate((function(e){return e[t]})).where((function(e){return e})).sum()}return[t,n]})),e.getColumnNames().filter((function(e){return"date"!==e})).filter((function(e){return-1===o.indexOf(e)})).map((function(t){var r=e.deflate((function(e){return e[t]})).distinct().toArray();return 1===r.length&&(r=r[0]),[t,r]})))))})).inflate().withIndex((function(e){return t(e.date).toDate()})))},y.populate=function(e,t){var r;switch(void 0===t&&(t="avg"),t){case"fill":r=e;break;default:r=e/this.getIndex().count()}return new m(this.generateSeries({value:function(e){return r}}))},y.fill=function(){var e=this.first().date.toDate(),t=this.last().date.toDate(),r=this.interval;console.time("blank");var n=m.blank(e,t,r,"missing");console.timeEnd("blank"),console.time("join");var a=this.joinOuterRight(n,(function(e){return e.date.valueOf()}),(function(e){return e.date.valueOf()}),(function(e,t){return e||t}));return console.timeEnd("join"),console.time("new timeseries"),console.timeEnd("new timeseries"),a},y.reduceToValue=function(e){return new m(this.generateSeries({value:function(t){return function(e,t){return void 0===t&&(t=[]),t.map((function(t){return e[t]})).filter((function(e){return e}))[0]||0}(t,e)}}).subset(["date","value"]))},y.clean=function(e,t){var r=t.lowerThreshold,n=t.upperThreshold;return new m(this.toArray().map((function(e){if(e.value>n||e.value<r){var t=e.value,a=e.flag,i=void 0===a?[]:a,u=l(e,["value","flag"]);return i||(i=[]),Array.isArray(i)||(i=[i]),f({value:void 0,raw:t,flag:["outlier"].concat(i)},u)}return e})))},m.blank=function(e,r,n,a){var i=n[0],u=n[1],o=void 0===u?1:u;if(["minute","hour","day","month","year"].indexOf(i)<0)throw console.error(l),new Error("interval type not supported");e=t(e),r=t(r);for(var f=[e],l=function(e){var r=e[0],n=e[1],a=t();return t().add(n,r).diff(a)}([i,o]);f[f.length-1].valueOf()<r.valueOf();)f.push(t(f[f.length-1]).add(o,i));var s=new m(f.map((function(e){return{date:e}})));return console.log(s.count()),a&&(s=s.generateSeries({flag:function(e){return[a]}})),new m(s)},m.aggregate=function(t){return Array.isArray(t)||(t=[t]),t=t.map((function(e){return new m(e)})),new m(e.DataFrame.concat(t).groupBy((function(e){return e.date})).select((function(e){var t={date:e.first().date};return e.getColumnNames().filter((function(e){return"date"!==e})).forEach((function(r){return t[r]=e.deflate((function(e){return e[r]})).sum()})),t})).inflate().toArray())},y.annualMonthlyAverage=function(e){var t=e.startDate,r=e.endDate;this.downsample(["month",1],"sum").between(t,r).getSeries("value").average()},y.annualIntensity=function(e){var r=this;void 0===e&&(e=1);var n=this.interval;return new m(this.groupBy((function(e){return e.date.year()})).select((function(i){var u,o=i.first().date,l=i.last().date.add(n[1]||1,n[0]||"month"),s=(u=o,365/t(l).diff(t(u),"day"));return f({startDate:o,endDate:l},a(r.valueColumns.map((function(t){return[t,i.deflate((function(e){return e[t]})).where((function(e){return e})).sum()*s/e]}))))})).inflate().renameSeries({startDate:"date"}).dropSeries("endDate"))},y.addBaselineDelta=function(e){var t;if(e instanceof m||(e=new m(e)),e.count()>1){var a,i=this.interval,u=e.interval;if(!r(i,u))throw console.error(i,u),new Error("baseline and data intervals do not match");switch(i[0]){case"day":a=function(e){return e.month()+"-"+e.date()};break;case"month":a=function(e){return e.month()};break;default:a=function(e){return 0}}var o=e.withIndex((function(e){return a(e.date)}));t=this.generateSeries({baseline:function(e){return t=a(e.date),(r=o.at(t))&&n(r,"value")?r.value:o.getSeries("value").average();var t,r}})}else t=this.generateSeries({baseline:function(t){return e.first().value}});return new m(t=t.generateSeries({delta:function(e){return(e.value-(t=e.baseline))/t;var t}}))},(p=[{key:"interval",get:function(){var e,r,n;return e=this.getIndex().window(2).select((function(e){return e.last()-e.first()})).detectValues().orderBy((function(e){return-e.Frequency})).orderBy((function(e){return e.Value})).first().Value,r=t(),(n=t().add(e)).diff(r,"month",!0)>=11?["year",Math.ceil(n.diff(r,"year",!0))]:n.diff(r,"day",!0)>=28?["month",Math.ceil(n.diff(r,"month",!0))]:n.diff(r,"hour",!0)>=23?["day",Math.ceil(n.diff(r,"day",!0))]:n.diff(r,"minute",!0)>=55?["hour",Math.ceil(n.diff(r,"hour",!0))]:["minute",n.diff(r,"minute")]}},{key:"valueColumns",get:function(){return this.detectTypes().where((function(e){return"number"===e.Type})).distinct((function(e){return e.Column})).getSeries("Column").toArray()}}])&&function(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}(m.prototype,p),m}(e.DataFrame)}));
//# sourceMappingURL=index.min.js.map

!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("dayjs"),require("data-forge"),require("lodash/isEqual"),require("lodash/has"),require("lodash/fromPairs"),require("lodash/toPairs"),require("simple-statistics"),require("distributions")):"function"==typeof define&&define.amd?define(["dayjs","data-forge","lodash/isEqual","lodash/has","lodash/fromPairs","lodash/toPairs","simple-statistics","distributions"],t):(e=e||self).timeseries=t(e.dayjs,e.dataForge,e.isEqual,e.has,e.fromPairs,e.toPairs,e.simpleStatistics,e.distributions)}(this,(function(e,t,r,n,a,u,i,o){e=e&&e.hasOwnProperty("default")?e.default:e;var f="default"in t?t.default:t;function s(){return(s=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(this,arguments)}r=r&&r.hasOwnProperty("default")?r.default:r,n=n&&n.hasOwnProperty("default")?n.default:n,a=a&&a.hasOwnProperty("default")?a.default:a,u=u&&u.hasOwnProperty("default")?u.default:u;var l=function(e,t,r){var n,i=t.startValue,o=t.endValue,f=t.entryIndex,l=t.numEntries,d=r.overrideValue,c=r.dateFunction,h=r.date,v=r.flag;if(-1===["pad","interpolate","average","dateFunction","value"].indexOf(e))throw new Error("fill Type not supported");return"pad"===e?(n=a(u(i).map((function(e){var t=e[0];return[t,i[t]]}))),v=v||["fill","pad"]):"interpolate"===e?(n=a(u(i).map((function(e){var t=e[0];return[t,i[t]+(f+1)*((o[t]-i[t])/(l+1))]}))),v=v||["fill",e]):"average"===e?(n=a(u(i).map((function(e){var t=e[0];return[t,(i[t]+o[t])/l]}))),v=v||["fill",e]):"dateFunction"===e&&c?(n=a(u(i).map((function(e){return[e[0],c(h)]}))),v=v||["fill",e]):"value"===e?(n=a(u(i).map((function(e){var t=e[0];return[t,"number"==typeof d?d:d[t]]}))),v=v||["fill",e]):(n=a(u(i).map((function(e){return[e[0],null]}))),v=["fill"]),s({},n,{flag:v})};function d(e){var r=e.deflate((function(e){return e.x})).toArray(),n=i.sampleStandardDeviation(r),a=i.mean(r);if(0===n){var u=e.generateSeries({ares:function(e){return 0}});return{R:0,std:n,mean:a,df:u}}var o=new t.DataFrame({values:r.map((function(e){return{x:e,ares:Math.abs(e-a)/n}}))});return{R:i.max(o.deflate((function(e){return e.ares})).toArray()),df:o,std:n,mean:a}}function c(e,t,r){var n=function(e,t,r){return 1-r/(2*(e-t+1))}(e,t,r),a=function(e,t){return new o.Studentt(t).inv(e)}(n,e-t-1);return{lambda:a*(e-t)/Math.sqrt((e-t-1+Math.pow(a,2))*(e-t+1)),p:n,t:a}}var h=function(e,t,r){return.6745*(e-r)/t};function v(e){var t=i.median(e),r=i.medianAbsoluteDeviation(e),n=(e=e.sort((function(e,t){return t-e})).filter((function(e){return e>0})).map((function(e){return[e,h(e,r,t)]}))).filter((function(e){return Math.abs(e[1])>=3.5}));return{thresholds:{upper:Math.min.apply(Math,[Infinity].concat(n.map((function(e){return e[0]})))),lower:0}}}var p=f.DataFrame;function m(e){var t=void 0===e?{}:e;if(t.lowerThreshold>t.upperThreshold)throw new Error("thresholds invalid");var r=this.where((function(e){return(t=e.value)<void 0||t>void 0;var t})).generateSeries({raw:function(e){return e.value},flag:function(e){var t=e.flag;return["outlier"].concat(void 0===t?[]:t)}}).transformSeries({value:function(e){return null}});return this.merge(r)}return p.prototype.setDateIndex=function(t){if(void 0===t&&(t="date"),-1===this.getColumnNames().indexOf(t))throw new Error("No Date Column in DataFrame");return this.orderBy((function(e){return e[t].valueOf()})).withIndex((function(t){return e(t.date).toDate()}))},p.prototype.getInterval=function(){var t,r,n;return t=this.getIndex().window(2).select((function(e){return e.last()-e.first()})).detectValues().orderBy((function(e){return-e.Frequency})).orderBy((function(e){return e.Value})).first().Value,r=e(),(n=e().add(t)).diff(r,"month",!0)>=11?["year",Math.ceil(n.diff(r,"year",!0))]:n.diff(r,"day",!0)>=28?["month",Math.ceil(n.diff(r,"month",!0))]:n.diff(r,"hour",!0)>=23?["day",Math.ceil(n.diff(r,"day",!0))]:n.diff(r,"minute",!0)>=55?["hour",Math.ceil(n.diff(r,"hour",!0))]:["minute",n.diff(r,"minute")]},p.prototype.getValueColumns=function(){return this.detectTypes().where((function(e){return"number"===e.Type})).distinct((function(e){return e.Column})).getSeries("Column").toArray()},p.prototype.getDateRange=function(t,r){var n=e(this.first().date),a=e(this.last().date);return r&&(n=n.startOf(r),a=a.endOf(r)),a.diff(n,t)},p.prototype.calculateThresholdOptions=function(e){var r,n,a,u,o=void 0===e?{}:e,f=o.k,s=o.filterZeros,l=void 0===s||s,h=o.filterNegative,p=void 0===h||h,m=this.where((function(e){return null==e.flag||Array.isArray(e.flag)&&0===e.flag.length})).where((function(e){return!isNaN(e.value)&&null!==e.value})).getSeries("value");return l&&(m=m.where((function(e){return 0!==e}))),p&&(m=m.where((function(e){return e>0}))),f||(f=m.count()<1e3?Math.floor(.15*m.count()):Math.min.apply(Math,[1e3,Math.floor(.02*m.count())])),m.count()<5?{}:{esd:function(e,r,n){void 0===e&&(e=[]),void 0===r&&(r=10),void 0===n&&(n=.05);for(var a,u=new t.DataFrame({values:e.map((function(e){return{x:e}}))}),i=u.getSeries("x").count(),o=1,f=[],s=!1;o<=r;){var l={};1===o?function(){var e=d(u),t=e.R,r=e.df,n=e.mean,i=e.std;a=r.where((function(e){return e.ares!==t})),l=Object.assign({},l,{mean:n,std:i,Value:r.where((function(e){return e.ares===t})).getSeries("x").first(),R:t})}():function(){var e=d(a),t=e.R,r=e.df,n=e.mean,u=e.std;a=r.where((function(e){return e.ares!==t})),l=Object.assign({},l,{mean:n,std:u,Value:r.where((function(e){return e.ares===t})).getSeries("x").first(),R:t})}();var h=c(i,o,n);if(l=Object.assign({},l,{lambda:h.lambda}),f.push(l),s&&l.R>l.lambda&&(s=!1),0===l.R)break;if(l.R<l.lambda){if(s)break;s=!0}o++}var v=(f=new t.DataFrame(f).generateSeries({outlier:function(e){return e.R>e.lambda}}).takeWhile((function(e){return e.outlier}))).where((function(e){return e.Value>0})).deflate((function(e){return e.Value}));return{outliers:f,thresholds:{lower:0,upper:v.count()>0?v.min():Infinity},iterations:o}}(m.toArray(),f).thresholds,box:(r=m.toArray(),n=i.quantile(r,.25),a=i.quantile(r,.75),{thresholds:{lowerInner:n-1.5*(u=a-n),upperInner:n-3*u,lowerOuter:a+1.5*u,upperOuter:a+3*u}}).thresholds,modz:v(m.toArray()).thresholds}},p.prototype.claculateStatistics=function(e){void 0===e&&(e={});var t=e.column,r=void 0===t?"value":t,n=e.filterZeros,a=void 0!==n&&n,u=e.filterNegative,o=void 0===u||u,f=this.deflate((function(e){return e[r]})).where((function(e){return!isNaN(e)}));o&&(f=f.where((function(e){return e>=0}))),a&&(f=f.where((function(e){return 0!==e})));var s=f.median(),l=f.average(),d=f.count(),c=f.std(),h=f.min(),v=f.max(),p=i.medianAbsoluteDeviation(f.toArray()),m=i.quantile(f.toArray(),.25),y=i.quantile(f.toArray(),.75);return{median:s,mean:l,count:d,std:c,min:h,max:v,mad:p,q1:m,q3:y,iqr:y-m}},p.prototype.transformAllSeries=function(e,t){var r=t.exclude,n=this,a=a=n.detectTypes().where((function(e){return"number"===e.Type})).distinct((function(e){return e.Column})).getSeries("Column").toArray();return r&&Array.isArray(r)&&(a=a.filter((function(e){return-1===r.indexOf(e)}))),a.forEach((function(t){var r;n=n.transformSeries(((r={})[t]=function(t){return isNaN(t)?t:e(t)},r))})),n},p.prototype.removeOutliers=m,p.prototype.clean=m,p.prototype.group=function(t,r){if(-1===["hour","day","month","year"].indexOf(t))throw new Error("interval type not supported");return this.groupBy((function(r){return e(r.date).startOf(t)}))},p.prototype.downsample=function(t,r){var n=t[0],u=t[1];if(void 0===r&&(r="sum"),-1===["hour","day","month","year"].indexOf(n))throw new Error("interval type not supported");if(-1===["sum","avg","median"].indexOf(r))throw new Error("aggregation type not suppported, only:");var i=function(e){return e.date.startOf(n)},o=this.getValueColumns();return u&&(i=function(e){return e.date.startOf(n).add(u,n)}),this.groupBy(i).select((function(e){return s({date:e.first().date.startOf(n)},a([].concat(o.map((function(t){var n;switch(r){case"median":n=e.deflate((function(e){return e[t]})).where((function(e){return e})).median();break;case"avg":n=e.deflate((function(e){return e[t]})).where((function(e){return e})).average();break;default:n=e.deflate((function(e){return e[t]})).where((function(e){return e})).sum()}return[t,n]})),e.getColumnNames().filter((function(e){return"date"!==e})).filter((function(e){return-1===o.indexOf(e)})).map((function(t){var r=e.deflate((function(e){return e[t]})).distinct().toArray();return 1===r.length&&(r=r[0]),[t,r]})))))})).inflate().withIndex((function(t){return e(t.date).toDate()}))},p.prototype.upsample=function(t,r){var n=t[0],a=t[1];return void 0===r&&(r="avg"),this.fillGaps(function(t){var r=t[0],n=t[1],a=void 0===n?1:n;return function(t,n){var u=t[0];return Math.floor(e(n[0]).diff(u,r,!0)/a)>0}}([n,a]),function(t,r,n){var a=r[0],u=r[1],i={},o=i.overrideValue,f=i.dateFunction,s=i.flag;return function(r,n){for(var i=e(r[0]),d=e(n[0]),c=Math.floor(e(d).diff(i,a)/u)-1,h=r[1],v=n[1],p=[],m=0;m<c;++m){var y=l(t,{startValue:h,endValue:v,entryIndex:m,numEntries:c},{overrideValue:o,dateFunction:f,flag:s}),g=e(i).add((m+1)*u,a).toDate(),w=[g.valueOf(),Object.assign({},y,{date:g})];p.push(w)}return p}}(r,[n,a]))},p.prototype.populateSeries=function(e,t){var r;switch(void 0===t&&(t="avg"),t){case"fill":r=e;break;default:r=e/this.count()}return this.generateSeries({value:function(e){return r}})},p.prototype.fill=function(){var e=this.first().date.toDate(),t=this.last().date.toDate(),r=this.getInterval(),n=p.blank(e,t,r,"missing");return this.joinOuterRight(n,(function(e){return e.date.valueOf()}),(function(e){return e.date.valueOf()}),(function(e,t){return e||t}))},p.prototype.reduceToValue=function(e){return this.generateSeries({value:function(t){return function(e,t){return void 0===t&&(t=[]),t.map((function(t){return e[t]})).filter((function(e){return e}))[0]||0}(t,e)}}).subset(["date","value"])},p.prototype.annualIntensity=function(e){var t=this;void 0===e&&(e=1);var r=this.getInterval();return this.groupBy((function(e){return e.date.year()})).select((function(n){var u,i=n.first().date,o=n.last().date.add(r[1]||1,r[0]||"month"),f=(u=i,365/dayjs(o).diff(dayjs(u),"day"));return s({startDate:i,endDate:o},a(t.getValueColumns().map((function(t){return[t,n.deflate((function(e){return e[t]})).where((function(e){return e})).sum()*f/e]}))))})).inflate().renameSeries({startDate:"date"}).dropSeries("endDate")},p.prototype.addBaselineDelta=function(e){var t;if(e instanceof p||(e=new p(e).setDateIndex()),e.count()>1){var a,u=this.getInterval(),i=e.interval;if(!r(u,i))throw console.error(u,i),new Error("baseline and data intervals do not match");switch(u[0]){case"day":a=function(e){return e.month()+"-"+e.date()};break;case"month":a=function(e){return e.month()};break;default:a=function(e){return 0}}var o=e.withIndex((function(e){return a(e.date)}));t=this.generateSeries({baseline:function(e){return t=a(e.date),(r=o.at(t))&&n(r,"value")?r.value:o.getSeries("value").average();var t,r}})}else t=this.generateSeries({baseline:function(t){return e.first().value}});return t.generateSeries({delta:function(e){return(e.value-(t=e.baseline))/t;var t}})},p.blank=function(t,r,n,a){var u=n[0],i=n[1],o=void 0===i?1:i;if(["minute","hour","day","month","year"].indexOf(u)<0)throw console.error(s),new Error("interval type not supported");t=e(t),r=e(r);for(var f=[t],s=function(t){var r=t[0],n=t[1],a=e();return e().add(n,r).diff(a)}([u,o]);f[f.length-1].valueOf()<r.valueOf();)f.push(e(f[f.length-1]).add(o,u));var l=new p(f.map((function(e){return{date:e}}))).setDateIndex();return a&&(l=l.generateSeries({flag:function(e){return[a]}})),l},p.aggregate=function(e){Array.isArray(e)||(e=[e]),e=e.map((function(e){return new p(e).setDateIndex()}));var t=new Set(e.map((function(e){return e.getValueColumns()})).reduce((function(e,t){return e.concat(t)}),[])),r=f.DataFrame.concat(e).groupBy((function(e){return e.date})).select((function(e){var r={date:e.first().date};return t.forEach((function(t){return r[t]=e.deflate((function(e){return e[t]})).sum()})),r})).inflate();return new p(r).setDateIndex()},p}));
//# sourceMappingURL=index.min.js.map

import{DataFrame as r}from"data-forge";import t from"dayjs";import e from"lodash/isEqual";import n from"lodash/fromPairs";import"lodash";import a from"lodash/toPairs";import{medianAbsoluteDeviation as i,quantile as o}from"simple-statistics";function u(){return(u=Object.assign||function(r){for(var t=1;t<arguments.length;t++){var e=arguments[t];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(r[n]=e[n])}return r}).apply(this,arguments)}var f=function(r){var e=r[0],n=r[1],a=void 0===n?1:n;return function(r,n){var i=r[0];return Math.floor(t(n[0]).diff(i,e,!0)/a)>0}},l=function(r,t,e){var i,o=t.startValue,f=t.endValue,l=t.entryIndex,d=t.numEntries,s=e.overrideValue,c=e.dateFunction,h=e.date,v=e.flag;if(-1===["pad","interpolate","average","dateFunction","value"].indexOf(r))throw new Error("fill Type not supported");return"pad"===r?(i=n(a(o).map(function(r){var t=r[0];return[t,o[t]]})),v=v||["fill","pad"]):"interpolate"===r?(i=n(a(o).map(function(r){var t=r[0];return[t,o[t]+(l+1)*((f[t]-o[t])/(d+1))]})),v=v||["fill",r]):"average"===r?(i=n(a(o).map(function(r){var t=r[0];return[t,(o[t]+f[t])/d]})),v=v||["fill",r]):"dateFunction"===r&&c?(i=n(a(o).map(function(r){return[r[0],c(h)]})),v=v||["fill",r]):"value"===r?(i=n(a(o).map(function(r){var t=r[0];return[t,"number"==typeof s?s:s[t]]})),v=v||["fill",r]):(i=n(a(o).map(function(r){return[r[0],null]})),v=["fill"]),u({},i,{flag:v})},d=function(r,e,n){var a=e[0],i=e[1],o=void 0===n?{}:n,u=o.overrideValue,f=o.dateFunction,d=o.flag;return function(e,n){for(var o=t(e[0]),s=t(n[0]),c=Math.floor(t(s).diff(o,a)/i)-1,h=e[1],v=n[1],p=[],m=0;m<c;++m){var y=l(r,{startValue:h,endValue:v,entryIndex:m,numEntries:c},{overrideValue:u,dateFunction:f,flag:d}),w=t(o).add((m+1)*i,a).toDate(),g=[w.valueOf(),Object.assign({},y,{date:w})];p.push(g)}return p}},s=function(a){var l,s;function c(t){void 0===t&&(t=[]),(t instanceof r||t instanceof c)&&(t=t.toArray());var e={values:t=t.sort(function(r,t){return new Date(r.date).valueOf()-new Date(t.date).valueOf()}),index:t.map(function(r){return new Date(r.date).valueOf()}),considerAllRows:!0};return a.call(this,e)||this}s=a,(l=c).prototype=Object.create(s.prototype),l.prototype.constructor=l,l.__proto__=s;var h,v=c.prototype;return v.dateRange=function(r,e){var n=t(this.first().date),a=t(this.last().date);return e&&(n=n.startOf(e),a=a.endOf(e)),a.diff(n,r)},v.at=function(r){return a.prototype.at.call(this,new Date(r).valueOf())},v.calculateThresholds=function(r){var t=void 0===r?{}:r,e=t.k,n=t.filterZeros,a=void 0===n||n,i=this.where(function(r){return null==r.flag||Array.isArray(r.flag)&&0===r.flag.length}).where(function(r){return!isNaN(r.value)&&null!==r.value}).getSeries("value");return a&&(i=i.where(function(r){return 0!==r})),e||(e=i.count()<1e3?Math.floor(.15*i.count()):Math.min.apply(Math,[1e3,Math.floor(.02*i.count())])),i.count()<5?{}:{esd:rosnerTest(i.toArray(),e).thresholds,box:boxPlotTest(i.toArray()).thresholds,modz:modifiedZScoreTest(i.toArray()).thresholds}},v.removeOutliers=function(r){var t=void 0===r?{}:r,e=t.lowerThreshold,n=t.upperThreshold;if(e>n)throw new Error("thresholds invalid");var a=function(r,t,e){return r<t||r>e};return this.generateSeries({raw:function(r){return a(r.value,e,n)?r.value:null},flag:function(r){return a(r.value,e,n)?["outlier"]:null}}).transformSeries({value:function(r){return a(r,e,n)?null:r}})},v.reset=function(){return this.withSeries({value:function(r){return r.raw&&!isNaN(r.raw)?r.raw:r.value}}).dropSeries(["flag","raw"])},v.group=function(r,e){if(-1===["hour","day","month","year"].indexOf(r))throw new Error("interval type not supported");return this.groupBy(function(e){return t(e.date).startOf(r)})},v.resample=function(r,n){var a=r[0],i=r[1],o=void 0===i?1:i;if(-1===["hour","day","month","year"].indexOf(a))throw new Error("interval type not supported");var u=this.interval;if(e(u,[a,o]))return this;var f=t(0);return t(0).add(u[1],u[0]).diff(f)<t(0).add(o,a).diff(f)?this.downsample([a,o],n):this.upsample([a,o],n)},v.upsample=function(r,t){var e=r[0],n=r[1];return void 0===t&&(t="avg"),this.fillGaps(f([e,n]),d(t,[e,n]))},v.downsample=function(r,e){var a=r[0],i=r[1];if(void 0===e&&(e="sum"),-1===["hour","day","month","year"].indexOf(a))throw new Error("interval type not supported");if(-1===["sum","avg","median"].indexOf(e))throw new Error("aggregation type not suppported, only:");var o=function(r){return t(r.date).startOf(a)};return i&&(o=function(r){return t(r.date).startOf(a).add(i,a)}),this.groupBy(o).select(function(r){return u({date:t(r.first().date).startOf(a).toDate()},n(r.getColumnNames().filter(function(r){return"date"!==r}).map(function(t){var n;switch(e){case"median":n=r.deflate(function(r){return r[t]}).median();break;case"avg":n=r.deflate(function(r){return r[t]}).average();break;default:n=r.deflate(function(r){return r[t]}).sum()}return[t,n]})))}).inflate().withIndex(function(r){return r.date.valueOf()})},v.calculateStatistics=function(r){var t=void 0===r?{}:r,e=t.filterZeros,n=void 0!==e&&e,a=t.filterNegative,u=void 0===a||a,f=this.deflate(function(r){return r[columnName]}).where(function(r){return!isNaN(r)});u&&(f=f.where(function(r){return r>=0})),n&&(f=f.where(function(r){return 0!==r}));var l=f.median(),d=f.average(),s=f.count(),c=f.std(),h=f.min(),v=f.max(),p=i(f.toArray()),m=o(f.toArray(),.25),y=o(f.toArray(),.75);return{median:l,mean:d,count:s,std:c,min:h,max:v,mad:p,q1:m,q3:y,iqr:y-m}},v.dataQuality=function(){return this.count(),this.getSeries("flag").where(function(r){return null==r||Array.isArray(r)&&0===r.length}).count(),this.getSeries("flag").where(function(r){return Array.isArray(r)}).where(function(r){return-1!==r.indexOf("missing")}).count(),this.getSeries("flag").where(function(r){return Array.isArray(r)}).where(function(r){return-1!==r.indexOf("outlier")}).count(),this.getSeries("flag").where(function(r){return Array.isArray(r)}).where(function(r){return-1!==r.indexOf("zeroFill")}).count(),{}},v.populate=function(r,t){var e;switch(void 0===t&&(t="avg"),t){case"fill":e=r;break;default:e=r/this.getIndex().count()}return this.generateSeries({value:function(r){return e}})},v.fill=function(r,t){return r&&Array.isArray(r)||(r=this.interval),new c(this.fillGaps(f(r),d(t,r)))},c.blank=function(r,e,n){var a=n[0],i=n[1],o=void 0===i?1:i;if(["minute","hour","day","month","year"].indexOf(a)<0)throw console.error(interval),new Error("interval type not supported");var l=new c([{date:new Date(r)},{date:new Date(e)}]).fillGaps(f([a,o]),function(r,e){var n=r[0],a=r[1];return function(r,e){for(var i=r[0],o=Math.floor(t(e[0]).diff(i,n)/a)-1,f=[],l=0;l<o;++l){var d=t(i).add((l+1)*a,n).toDate();f.push([d.valueOf(),u({date:d,value:null},void 0)])}return f}}([a,o])).between(r,e);return new c(l)},c.aggregate=function(t){return Array.isArray(t)||(t=[t]),t=t.map(function(r){return new c(r)}),new c(r.concat(t).groupBy(function(r){return r.date}).select(function(r){var t={date:r.first().date};return r.getColumnNames().filter(function(r){return"date"!==r}).forEach(function(e){return t[e]=r.deflate(function(r){return r[e]}).sum()}),t}).inflate().toArray())},(h=[{key:"interval",get:function(){var r,e,n,a=this.first().date,i=this.last().date;return r=this.between(a,i).getIndex().window(2).select(function(r){return r.last()-r.first()}).detectValues().orderBy(function(r){return r.Frequency}).orderBy(function(r){return r.Value}).last().Value,e=t(),(n=t().add(r)).diff(e,"year",!0)>=1?["year",n.diff(e,"year")]:n.diff(e,"month",!0)>=1?["month",n.diff(e,"month")]:n.diff(e,"day",!0)>=1?["day",n.diff(e,"day")]:n.diff(e,"hour",!0)>=1?["hour",n.diff(e,"hour")]:["minute",n.diff(e,"minute")]}}])&&function(r,t){for(var e=0;e<t.length;e++){var n=t[e];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(r,n.key,n)}}(c.prototype,h),c}(r);export default s;
//# sourceMappingURL=index.module.js.map

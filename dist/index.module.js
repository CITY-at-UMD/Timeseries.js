import{DataFrame as r}from"data-forge";import e from"dayjs";import t from"lodash/isEqual";import n from"lodash/fromPairs";import"lodash";import a from"lodash/toPairs";import{medianAbsoluteDeviation as i,quantile as o}from"simple-statistics";function u(){return(u=Object.assign||function(r){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(r[n]=t[n])}return r}).apply(this,arguments)}var f=function(r){var t=r[0],n=r[1],a=void 0===n?1:n;return function(r,n){var i=r[0];return Math.floor(e(n[0]).diff(i,t,!0)/a)>0}},l=function(r,e,t){var i,o=e.startValue,f=e.endValue,l=e.entryIndex,s=e.numEntries,d=t.overrideValue,c=t.dateFunction,v=t.date,h=t.flag;if(-1===["pad","interpolate","average","dateFunction","value"].indexOf(r))throw new Error("fill Type not supported");return"pad"===r?(i=n(a(o).map(function(r){var e=r[0];return[e,o[e]]})),h=h||["fill","pad"]):"interpolate"===r?(i=n(a(o).map(function(r){var e=r[0];return[e,o[e]+(l+1)*((f[e]-o[e])/(s+1))]})),h=h||["fill",r]):"average"===r?(i=n(a(o).map(function(r){var e=r[0];return[e,(o[e]+f[e])/s]})),h=h||["fill",r]):"dateFunction"===r&&c?(i=n(a(o).map(function(r){return[r[0],c(v)]})),h=h||["fill",r]):"value"===r?(i=n(a(o).map(function(r){var e=r[0];return[e,"number"==typeof d?d:d[e]]})),h=h||["fill",r]):(i=n(a(o).map(function(r){return[r[0],null]})),h=["fill"]),u({},i,{flag:h})},s=function(r,t,n){var a=t[0],i=t[1],o=void 0===n?{}:n,u=o.overrideValue,f=o.dateFunction,s=o.flag;return function(t,n){for(var o=e(t[0]),d=e(n[0]),c=Math.floor(e(d).diff(o,a)/i)-1,v=t[1],h=n[1],p=[],m=0;m<c;++m){var y=l(r,{startValue:v,endValue:h,entryIndex:m,numEntries:c},{overrideValue:u,dateFunction:f,flag:s}),w=e(o).add((m+1)*i,a).toDate(),g=[w.valueOf(),Object.assign({},y,{date:w})];p.push(g)}return p}},d=function(a){var l,d;function c(e){void 0===e&&(e=[]),(e instanceof r||e instanceof c)&&(e=e.toArray());var t={values:e=e.sort(function(r,e){return new Date(r.date).valueOf()-new Date(e.date).valueOf()}),index:e.map(function(r){return new Date(r.date).valueOf()}),considerAllRows:!0};return a.call(this,t)||this}d=a,(l=c).prototype=Object.create(d.prototype),l.prototype.constructor=l,l.__proto__=d;var v,h=c.prototype;return h.dateRange=function(r,t){var n=e(this.first().date),a=e(this.last().date);return t&&(n=n.startOf(t),a=a.endOf(t)),a.diff(n,r)},h.at=function(r){return a.prototype.at.call(this,new Date(r).valueOf())},h.calculateThresholds=function(r){var e=void 0===r?{}:r,t=e.k,n=e.filterZeros,a=void 0===n||n,i=this.where(function(r){return null==r.flag||Array.isArray(r.flag)&&0===r.flag.length}).where(function(r){return!isNaN(r.value)&&null!==r.value}).getSeries("value");return a&&(i=i.where(function(r){return 0!==r})),t||(t=i.count()<1e3?Math.floor(.15*i.count()):Math.min.apply(Math,[1e3,Math.floor(.02*i.count())])),i.count()<5?{}:{esd:rosnerTest(i.toArray(),t).thresholds,box:boxPlotTest(i.toArray()).thresholds,modz:modifiedZScoreTest(i.toArray()).thresholds}},h.removeOutliers=function(r){var e=void 0===r?{}:r,t=e.lowerThreshold,n=e.upperThreshold;if(t>n)throw new Error("thresholds invalid");var a=function(r,e,t){return r<e||r>t};return this.generateSeries({raw:function(r){return a(r.value,t,n)?r.value:null},flag:function(r){return a(r.value,t,n)?["outlier"]:null}}).transformSeries({value:function(r){return a(r,t,n)?null:r}})},h.reset=function(){return this.withSeries({value:function(r){return r.raw&&!isNaN(r.raw)?r.raw:r.value}}).dropSeries(["flag","raw"])},h.group=function(r,t){if(-1===["hour","day","month","year"].indexOf(r))throw new Error("interval type not supported");return this.groupBy(function(t){return e(t.date).startOf(r)})},h.resample=function(r,n){var a=r[0],i=r[1],o=void 0===i?1:i;if(-1===["hour","day","month","year"].indexOf(a))throw new Error("interval type not supported");var u=this.interval;if(t(u,[a,o]))return this;var f=e(0);return e(0).add(u[1],u[0]).diff(f)<e(0).add(o,a).diff(f)?this.downsample([a,o],n):this.upsample([a,o],n)},h.upsample=function(r,e){var t=r[0],n=r[1];return void 0===e&&(e="avg"),this.fillGaps(f([t,n]),s(e,[t,n]))},h.downsample=function(r,t){var a=r[0],i=r[1];if(void 0===t&&(t="sum"),-1===["hour","day","month","year"].indexOf(a))throw new Error("interval type not supported");if(-1===["sum","avg","median"].indexOf(t))throw new Error("aggregation type not suppported, only:");var o=function(r){return e(r.date).startOf(a)};return i&&(o=function(r){return e(r.date).startOf(a).add(i,a)}),this.groupBy(o).select(function(r){return u({date:e(r.first().date).startOf(a).toDate()},n(r.getColumnNames().filter(function(r){return"date"!==r}).map(function(e){var n;switch(t){case"median":n=r.deflate(function(r){return r[e]}).median();break;case"avg":n=r.deflate(function(r){return r[e]}).average();break;default:n=r.deflate(function(r){return r[e]}).sum()}return[e,n]})))}).inflate().withIndex(function(r){return r.date.valueOf()})},h.calculateStatistics=function(r){var e=void 0===r?{}:r,t=e.filterZeros,n=void 0!==t&&t,a=e.filterNegative,u=void 0===a||a,f=this.deflate(function(r){return r[columnName]}).where(function(r){return!isNaN(r)});u&&(f=f.where(function(r){return r>=0})),n&&(f=f.where(function(r){return 0!==r}));var l=f.median(),s=f.average(),d=f.count(),c=f.std(),v=f.min(),h=f.max(),p=i(f.toArray()),m=o(f.toArray(),.25),y=o(f.toArray(),.75);return{median:l,mean:s,count:d,std:c,min:v,max:h,mad:p,q1:m,q3:y,iqr:y-m}},h.dataQuality=function(){return this.count(),this.getSeries("flag").where(function(r){return null==r||Array.isArray(r)&&0===r.length}).count(),this.getSeries("flag").where(function(r){return Array.isArray(r)}).where(function(r){return-1!==r.indexOf("missing")}).count(),this.getSeries("flag").where(function(r){return Array.isArray(r)}).where(function(r){return-1!==r.indexOf("outlier")}).count(),this.getSeries("flag").where(function(r){return Array.isArray(r)}).where(function(r){return-1!==r.indexOf("zeroFill")}).count(),{}},h.populate=function(r,e){var t;switch(void 0===e&&(e="avg"),e){case"fill":t=r;break;default:t=r/this.getIndex().count()}return this.generateSeries({value:function(r){return t}})},h.fill=function(r,e){return r&&Array.isArray(r)||(r=this.interval),new c(this.fillGaps(f(r),s(e,r)))},h.reduceToValue=function(r){return new c(this.generateSeries({value:function(e){return function(r,e){return void 0===e&&(e=[]),e.map(function(e){return r[e]}).filter(function(r){return r})[0]||0}(e,r)}}).subset(["date","value"]))},h.clean=function(r,e){void 0===r&&(r="value");var t=e.lowerThreshold,n=e.upperThreshold;return new c(this.toArray().map(function(e){var a=e[r];return a>n||a<t?u({},e,{value:void 0,raw:a}):e}))},c.blank=function(r,t,n){var a=n[0],i=n[1],o=void 0===i?1:i;if(["minute","hour","day","month","year"].indexOf(a)<0)throw console.error(interval),new Error("interval type not supported");var l=new c([{date:new Date(r)},{date:new Date(t)}]).fillGaps(f([a,o]),function(r,t){var n=r[0],a=r[1];return function(r,t){for(var i=r[0],o=Math.floor(e(t[0]).diff(i,n)/a)-1,f=[],l=0;l<o;++l){var s=e(i).add((l+1)*a,n).toDate();f.push([s.valueOf(),u({date:s,value:null},void 0)])}return f}}([a,o])).between(r,t);return new c(l)},c.aggregate=function(e){return Array.isArray(e)||(e=[e]),e=e.map(function(r){return new c(r)}),new c(r.concat(e).groupBy(function(r){return r.date}).select(function(r){var e={date:r.first().date};return r.getColumnNames().filter(function(r){return"date"!==r}).forEach(function(t){return e[t]=r.deflate(function(r){return r[t]}).sum()}),e}).inflate().toArray())},h.annualMonthlyAverage=function(r){var e=r.startDate,t=r.endDate;this.downsample(["month",1],"sum").between(e,t).getSeries("value").average()},(v=[{key:"interval",get:function(){var r,t,n,a=this.first().date,i=this.last().date;return r=this.between(a,i).getIndex().window(2).select(function(r){return r.last()-r.first()}).detectValues().orderBy(function(r){return r.Frequency}).orderBy(function(r){return r.Value}).last().Value,t=e(),(n=e().add(r)).diff(t,"year",!0)>=1?["year",n.diff(t,"year")]:n.diff(t,"month",!0)>=1?["month",n.diff(t,"month")]:n.diff(t,"day",!0)>=1?["day",n.diff(t,"day")]:n.diff(t,"hour",!0)>=1?["hour",n.diff(t,"hour")]:["minute",n.diff(t,"minute")]}}])&&function(r,e){for(var t=0;t<e.length;t++){var n=e[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(r,n.key,n)}}(c.prototype,v),c}(r);export default d;
//# sourceMappingURL=index.module.js.map

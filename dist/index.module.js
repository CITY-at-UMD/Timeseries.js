import{DataFrame as e}from"data-forge";import r from"dayjs";import t from"lodash/isEqual";import n from"lodash/has";import a from"lodash/fromPairs";import i from"lodash/toPairs";import{median as u,medianAbsoluteDeviation as o,quantile as f,sampleStandardDeviation as l,mean as s,max as c}from"simple-statistics";import{Studentt as d}from"distributions";function h(){return(h=Object.assign||function(e){for(var r=1;r<arguments.length;r++){var t=arguments[r];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])}return e}).apply(this,arguments)}function v(e,r){if(null==e)return{};var t,n,a={},i=Object.keys(e);for(n=0;n<i.length;n++)r.indexOf(t=i[n])>=0||(a[t]=e[t]);return a}var m=function(e,r,t){var n,u=r.startValue,o=r.endValue,f=r.entryIndex,l=r.numEntries,s=t.overrideValue,c=t.dateFunction,d=t.date,v=t.flag;if(-1===["pad","interpolate","average","dateFunction","value"].indexOf(e))throw new Error("fill Type not supported");return"pad"===e?(n=a(i(u).map((function(e){var r=e[0];return[r,u[r]]}))),v=v||["fill","pad"]):"interpolate"===e?(n=a(i(u).map((function(e){var r=e[0];return[r,u[r]+(f+1)*((o[r]-u[r])/(l+1))]}))),v=v||["fill",e]):"average"===e?(n=a(i(u).map((function(e){var r=e[0];return[r,(u[r]+o[r])/l]}))),v=v||["fill",e]):"dateFunction"===e&&c?(n=a(i(u).map((function(e){return[e[0],c(d)]}))),v=v||["fill",e]):"value"===e?(n=a(i(u).map((function(e){var r=e[0];return[r,"number"==typeof s?s:s[r]]}))),v=v||["fill",e]):(n=a(i(u).map((function(e){return[e[0],null]}))),v=["fill"]),h({},n,{flag:v})};function p(r){var t=r.deflate((function(e){return e.x})).toArray(),n=l(t),a=s(t);if(0===n){var i=r.generateSeries({ares:function(e){return 0}});return{R:0,std:n,mean:a,df:i}}var u=new e({values:t.map((function(e){return{x:e,ares:Math.abs(e-a)/n}}))});return{R:c(u.deflate((function(e){return e.ares})).toArray()),df:u,std:n,mean:a}}function w(e,r,t){var n=function(e,r,t){return 1-t/(2*(e-r+1))}(e,r,t),a=function(e,r){return new d(r).inv(e)}(n,e-r-1);return{lambda:a*(e-r)/Math.sqrt((e-r-1+Math.pow(a,2))*(e-r+1)),p:n,t:a}}var g=function(e,r,t){return.6745*(e-t)/r};function y(e){var r=u(e),t=o(e),n=(e=e.sort((function(e,r){return r-e})).filter((function(e){return e>0})).map((function(e){return[e,g(e,t,r)]}))).filter((function(e){return Math.abs(e[1])>=3.5}));return{thresholds:{upper:Math.min.apply(Math,[Infinity].concat(n.map((function(e){return e[0]})))),lower:0}}}var b=function(i){var u,l;function s(t){if(void 0===t&&(t=[]),t instanceof s)return t||function(e){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}();t instanceof e&&(t=t.toArray());var n={values:t=t.map((function(e){var t=e.date,n=v(e,["date"]);return h({date:r(t)},n)})).sort((function(e,r){return e.date.valueOf()-r.date.valueOf()})),index:t.map((function(e){return e.date.toDate()})),considerAllRows:!0};return i.call(this,n)||this}l=i,(u=s).prototype=Object.create(l.prototype),u.prototype.constructor=u,u.__proto__=l;var c,d=s.prototype;return d.dateRange=function(e,t){var n=r(this.first().date),a=r(this.last().date);return t&&(n=n.startOf(t),a=a.endOf(t)),a.diff(n,e)},d.at=function(e){return i.prototype.at.call(this,r(e))},d.calculateThresholds=function(r){var t,n,a,i,u=void 0===r?{}:r,o=u.k,l=u.filterZeros,s=void 0===l||l,c=u.filterNegative,d=void 0===c||c,h=this.where((function(e){return null==e.flag||Array.isArray(e.flag)&&0===e.flag.length})).where((function(e){return!isNaN(e.value)&&null!==e.value})).getSeries("value");return s&&(h=h.where((function(e){return 0!==e}))),d&&(h=h.where((function(e){return e>0}))),o||(o=h.count()<1e3?Math.floor(.15*h.count()):Math.min.apply(Math,[1e3,Math.floor(.02*h.count())])),h.count()<5?{}:{esd:function(r,t,n){void 0===r&&(r=[]),void 0===t&&(t=10),void 0===n&&(n=.05);for(var a,i=new e({values:r.map((function(e){return{x:e}}))}),u=i.getSeries("x").count(),o=1,f=[],l=!1;o<=t;){var s={};1===o?function(){var e=p(i),r=e.R,t=e.df,n=e.mean,u=e.std;a=t.where((function(e){return e.ares!==r})),s=Object.assign({},s,{mean:n,std:u,Value:t.where((function(e){return e.ares===r})).getSeries("x").first(),R:r})}():function(){var e=p(a),r=e.R,t=e.df,n=e.mean,i=e.std;a=t.where((function(e){return e.ares!==r})),s=Object.assign({},s,{mean:n,std:i,Value:t.where((function(e){return e.ares===r})).getSeries("x").first(),R:r})}();var c=w(u,o,n);if(s=Object.assign({},s,{lambda:c.lambda}),f.push(s),l&&s.R>s.lambda&&(l=!1),0===s.R)break;if(s.R<s.lambda){if(l)break;l=!0}o++}var d=(f=new e(f).generateSeries({outlier:function(e){return e.R>e.lambda}}).takeWhile((function(e){return e.outlier}))).where((function(e){return e.Value>0})).deflate((function(e){return e.Value}));return{outliers:f,thresholds:{lower:0,upper:d.count()>0?d.min():Infinity},iterations:o}}(h.toArray(),o).thresholds,box:(t=h.toArray(),n=f(t,.25),a=f(t,.75),{thresholds:{lowerInner:n-1.5*(i=a-n),upperInner:n-3*i,lowerOuter:a+1.5*i,upperOuter:a+3*i}}).thresholds,modz:y(h.toArray()).thresholds}},d.calculateStatistics=function(e){var r=void 0===e?{}:e,t=r.column,n=void 0===t?"value":t,a=r.filterZeros,i=void 0!==a&&a,u=r.filterNegative,l=void 0===u||u,s=this.deflate((function(e){return e[n]})).where((function(e){return!isNaN(e)}));l&&(s=s.where((function(e){return e>=0}))),i&&(s=s.where((function(e){return 0!==e})));var c=s.median(),d=s.average(),h=s.count(),v=s.std(),m=s.min(),p=s.max(),w=o(s.toArray()),g=f(s.toArray(),.25),y=f(s.toArray(),.75);return{median:c,mean:d,count:h,std:v,min:m,max:p,mad:w,q1:g,q3:y,iqr:y-g}},d.dataQuality=function(){return this.count(),this.getSeries("flag").where((function(e){return null==e||Array.isArray(e)&&0===e.length})).count(),this.getSeries("flag").where((function(e){return Array.isArray(e)})).where((function(e){return-1!==e.indexOf("missing")})).count(),this.getSeries("flag").where((function(e){return Array.isArray(e)})).where((function(e){return-1!==e.indexOf("outlier")})).count(),this.getSeries("flag").where((function(e){return Array.isArray(e)})).where((function(e){return-1!==e.indexOf("zeroFill")})).count(),{}},d.transformAll=function(e,r){void 0===e&&(e=function(e){return e});var t=this;return r||(r=t.detectTypes().where((function(e){return"number"===e.Type})).distinct((function(e){return e.Column})).getSeries("Column").toArray()),r.forEach((function(r){var n;t=t.transformSeries(((n={})[r]=function(r){return isNaN(r)?r:e(r)},n))})),new s(t)},d.removeOutliers=function(e){var r=void 0===e?{}:e,t=r.lowerThreshold,n=r.upperThreshold;if(t>n)throw new Error("thresholds invalid");var a=function(e,r,t){return e<r||e>t};return new s(this.generateSeries({raw:function(e){return a(e.value,t,n)?e.value:null},flag:function(e){return a(e.value,t,n)?["outlier"]:null}}).transformSeries({value:function(e){return a(e,t,n)?null:e}}))},d.reset=function(){return this.withSeries({value:function(e){return e.raw&&!isNaN(e.raw)?e.raw:e.value}}).dropSeries(["flag","raw"])},d.group=function(e,t){if(-1===["hour","day","month","year"].indexOf(e))throw new Error("interval type not supported");return this.groupBy((function(t){return r(t.date).startOf(e)}))},d.resample=function(e,n){var a=e[0],i=e[1],u=void 0===i?1:i;if(-1===["hour","day","month","year"].indexOf(a))throw new Error("interval type not supported");var o=this.interval;if(t(o,[a,u]))return this;var f=r(0);return r(0).add(o[1],o[0]).diff(f)<r(0).add(u,a).diff(f)?this.downsample([a,u],n):this.upsample([a,u],n)},d.upsample=function(e,t){var n=e[0],a=e[1];return void 0===t&&(t="avg"),new s(this.fillGaps(function(e){var t=e[0],n=e[1],a=void 0===n?1:n;return function(e,n){var i=e[0];return Math.floor(r(n[0]).diff(i,t,!0)/a)>0}}([n,a]),function(e,t,n){var a=t[0],i=t[1],u={},o=u.overrideValue,f=u.dateFunction,l=u.flag;return function(t,n){for(var u=r(t[0]),s=r(n[0]),c=Math.floor(r(s).diff(u,a)/i)-1,d=t[1],h=n[1],v=[],p=0;p<c;++p){var w=m(e,{startValue:d,endValue:h,entryIndex:p,numEntries:c},{overrideValue:o,dateFunction:f,flag:l}),g=r(u).add((p+1)*i,a).toDate(),y=[g.valueOf(),Object.assign({},w,{date:g})];v.push(y)}return v}}(t,[n,a])))},d.downsample=function(e,t){var n=e[0],i=e[1];if(void 0===t&&(t="sum"),-1===["hour","day","month","year"].indexOf(n))throw new Error("interval type not supported");if(-1===["sum","avg","median"].indexOf(t))throw new Error("aggregation type not suppported, only:");var u=function(e){return e.date.startOf(n)},o=this.valueColumns;return i&&(u=function(e){return e.date.startOf(n).add(i,n)}),new s(this.groupBy(u).select((function(e){return h({date:e.first().date.startOf(n)},a([].concat(o.map((function(r){var n;switch(t){case"median":n=e.deflate((function(e){return e[r]})).where((function(e){return e})).median();break;case"avg":n=e.deflate((function(e){return e[r]})).where((function(e){return e})).average();break;default:n=e.deflate((function(e){return e[r]})).where((function(e){return e})).sum()}return[r,n]})),e.getColumnNames().filter((function(e){return"date"!==e})).filter((function(e){return-1===o.indexOf(e)})).map((function(r){var t=e.deflate((function(e){return e[r]})).distinct().toArray();return 1===t.length&&(t=t[0]),[r,t]})))))})).inflate().withIndex((function(e){return r(e.date).toDate()})))},d.populate=function(e,r){var t;switch(void 0===r&&(r="avg"),r){case"fill":t=e;break;default:t=e/this.getIndex().count()}return new s(this.generateSeries({value:function(e){return t}}))},d.fill=function(){var e=this.first().date.toDate(),r=this.last().date.toDate(),t=this.interval;console.time("blank");var n=s.blank(e,r,t,"missing");console.timeEnd("blank"),console.time("join");var a=this.joinOuterRight(n,(function(e){return e.date.valueOf()}),(function(e){return e.date.valueOf()}),(function(e,r){return e||r}));return console.timeEnd("join"),console.time("new timeseries"),console.timeEnd("new timeseries"),a},d.reduceToValue=function(e){return new s(this.generateSeries({value:function(r){return function(e,r){return void 0===r&&(r=[]),r.map((function(r){return e[r]})).filter((function(e){return e}))[0]||0}(r,e)}}).subset(["date","value"]))},d.clean=function(e,r){var t=r.lowerThreshold,n=r.upperThreshold;return new s(this.toArray().map((function(e){if(e.value>n||e.value<t){var r=e.value,a=e.flag,i=void 0===a?[]:a,u=v(e,["value","flag"]);return i||(i=[]),Array.isArray(i)||(i=[i]),h({value:void 0,raw:r,flag:["outlier"].concat(i)},u)}return e})))},s.blank=function(e,t,n,a){var i=n[0],u=n[1],o=void 0===u?1:u;if(["minute","hour","day","month","year"].indexOf(i)<0)throw console.error(l),new Error("interval type not supported");e=r(e),t=r(t);for(var f=[e],l=function(e){var t=e[0],n=e[1],a=r();return r().add(n,t).diff(a)}([i,o]);f[f.length-1].valueOf()<t.valueOf();)f.push(r(f[f.length-1]).add(o,i));var c=new s(f.map((function(e){return{date:e}})));return console.log(c.count()),a&&(c=c.generateSeries({flag:function(e){return[a]}})),new s(c)},s.aggregate=function(r){return Array.isArray(r)||(r=[r]),r=r.map((function(e){return new s(e)})),new s(e.concat(r).groupBy((function(e){return e.date})).select((function(e){var r={date:e.first().date};return e.getColumnNames().filter((function(e){return"date"!==e})).forEach((function(t){return r[t]=e.deflate((function(e){return e[t]})).sum()})),r})).inflate().toArray())},d.annualMonthlyAverage=function(e){var r=e.startDate,t=e.endDate;this.downsample(["month",1],"sum").between(r,t).getSeries("value").average()},d.annualIntensity=function(e){var t=this;void 0===e&&(e=1);var n=this.interval;return new s(this.groupBy((function(e){return e.date.year()})).select((function(i){var u,o=i.first().date,f=i.last().date.add(n[1]||1,n[0]||"month"),l=(u=o,365/r(f).diff(r(u),"day"));return h({startDate:o,endDate:f},a(t.valueColumns.map((function(r){return[r,i.deflate((function(e){return e[r]})).where((function(e){return e})).sum()*l/e]}))))})).inflate().renameSeries({startDate:"date"}).dropSeries("endDate"))},d.addBaselineDelta=function(e){var r;if(e instanceof s||(e=new s(e)),e.count()>1){var a,i=this.interval,u=e.interval;if(!t(i,u))throw console.error(i,u),new Error("baseline and data intervals do not match");switch(i[0]){case"day":a=function(e){return e.month()+"-"+e.date()};break;case"month":a=function(e){return e.month()};break;default:a=function(e){return 0}}var o=e.withIndex((function(e){return a(e.date)}));r=this.generateSeries({baseline:function(e){return r=a(e.date),(t=o.at(r))&&n(t,"value")?t.value:o.getSeries("value").average();var r,t}})}else r=this.generateSeries({baseline:function(r){return e.first().value}});return new s(r=r.generateSeries({delta:function(e){return(e.value-(r=e.baseline))/r;var r}}))},(c=[{key:"interval",get:function(){var e,t,n;return e=this.getIndex().window(2).select((function(e){return e.last()-e.first()})).detectValues().orderBy((function(e){return-e.Frequency})).orderBy((function(e){return e.Value})).first().Value,t=r(),(n=r().add(e)).diff(t,"month",!0)>=11?["year",Math.ceil(n.diff(t,"year",!0))]:n.diff(t,"day",!0)>=28?["month",Math.ceil(n.diff(t,"month",!0))]:n.diff(t,"hour",!0)>=23?["day",Math.ceil(n.diff(t,"day",!0))]:n.diff(t,"minute",!0)>=55?["hour",Math.ceil(n.diff(t,"hour",!0))]:["minute",n.diff(t,"minute")]}},{key:"valueColumns",get:function(){return this.detectTypes().where((function(e){return"number"===e.Type})).distinct((function(e){return e.Column})).getSeries("Column").toArray()}}])&&function(e,r){for(var t=0;t<r.length;t++){var n=r[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}(s.prototype,c),s}(e);export default b;
//# sourceMappingURL=index.module.js.map

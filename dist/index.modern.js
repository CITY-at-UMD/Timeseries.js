import{DataFrame as e}from"data-forge";import r from"dayjs";import a from"lodash/isEqual";import t from"lodash/fromPairs";import"lodash";import n from"lodash/toPairs";import{medianAbsoluteDeviation as i,quantile as o}from"simple-statistics";function l(){return(l=Object.assign||function(e){for(var r=1;r<arguments.length;r++){var a=arguments[r];for(var t in a)Object.prototype.hasOwnProperty.call(a,t)&&(e[t]=a[t])}return e}).apply(this,arguments)}var s=e=>{var a=r(),t=r().add(e);return t.diff(a,"year",!0)>=1?["year",t.diff(a,"year")]:t.diff(a,"month",!0)>=1?["month",t.diff(a,"month")]:t.diff(a,"day",!0)>=1?["day",t.diff(a,"day")]:t.diff(a,"hour",!0)>=1?["hour",t.diff(a,"hour")]:["minute",t.diff(a,"minute")]},u=e=>{var[a,t=1]=e;return(e,n)=>{var i=e[0];return Math.floor(r(n[0]).diff(i,a,!0)/t)>0}},d=(e,a)=>{var[t,n]=e;return(e,i)=>{for(var o=e[0],s=Math.floor(r(i[0]).diff(o,t)/n)-1,u=[],d=0;d<s;++d){var f=r(o).add((d+1)*n,t).toDate();u.push([f.valueOf(),l({date:f,value:null},a&&{flag:[a]})])}return u}},f=(e,r,a)=>{var i,{startValue:o,endValue:s,entryIndex:u,numEntries:d}=r,{overrideValue:f,dateFunction:v,date:h,flag:p}=a;if(-1===["pad","interpolate","average","dateFunction","value"].indexOf(e))throw new Error("fill Type not supported");return"pad"===e?(i=t(n(o).map(e=>{var[r,a]=e;return[r,o[r]]})),p=p||["fill","pad"]):"interpolate"===e?(i=t(n(o).map(e=>{var[r,a]=e;return[r,o[r]+(u+1)*((s[r]-o[r])/(d+1))]})),p=p||["fill",e]):"average"===e?(i=t(n(o).map(e=>{var[r,a]=e;return[r,(o[r]+s[r])/d]})),p=p||["fill",e]):"dateFunction"===e&&v?(i=t(n(o).map(e=>{var[r,a]=e;return[r,v(h)]})),p=p||["fill",e]):"value"===e?(i=t(n(o).map(e=>{var[r,a]=e;return[r,"number"==typeof f?f:f[r]]})),p=p||["fill",e]):(i=t(n(o).map(e=>{var[r,a]=e;return[r,null]})),p=["fill"]),l({},i,{flag:p})},v=function(e,a,t){var[n,i]=a,{overrideValue:o,dateFunction:l,flag:s}=void 0===t?{}:t;return(a,t)=>{for(var u=r(a[0]),d=r(t[0]),v=Math.floor(r(d).diff(u,n)/i)-1,h=a[1],p=t[1],m=[],w=0;w<v;++w){var c=f(e,{startValue:h,endValue:p,entryIndex:w,numEntries:v},{overrideValue:o,dateFunction:l,flag:s}),y=r(u).add((w+1)*i,n).toDate(),g=[y.valueOf(),Object.assign({},c,{date:y})];m.push(g)}return m}};class h extends e{constructor(r){void 0===r&&(r=[]),(r instanceof e||r instanceof h)&&(r=r.toArray()),super({values:r=r.sort((e,r)=>new Date(e.date).valueOf()-new Date(r.date).valueOf()),index:r.map(e=>{var{date:r}=e;return new Date(r).valueOf()}),considerAllRows:!0})}get interval(){var e=this.first().date,r=this.last().date,a=this.between(e,r).getIndex().window(2).select(function(e){return e.last()-e.first()}).detectValues().orderBy(e=>e.Frequency).orderBy(e=>e.Value).last().Value;return s(a)}dateRange(e,a){var t=r(this.first().date),n=r(this.last().date);return a&&(t=t.startOf(a),n=n.endOf(a)),n.diff(t,e)}at(e){return super.at(new Date(e).valueOf())}calculateThresholds(e){var{k:r,filterZeros:a=!0}=void 0===e?{}:e,t=this.where(e=>null==e.flag||Array.isArray(e.flag)&&0===e.flag.length).where(e=>!isNaN(e.value)&&null!==e.value).getSeries("value");if(a&&(t=t.where(e=>0!==e)),r||(r=t.count()<1e3?Math.floor(.15*t.count()):Math.min(1e3,Math.floor(.02*t.count()))),t.count()<5)return{};var{thresholds:n}=rosnerTest(t.toArray(),r),{thresholds:i}=boxPlotTest(t.toArray()),{thresholds:o}=modifiedZScoreTest(t.toArray());return{esd:n,box:i,modz:o}}removeOutliers(e){var{lowerThreshold:r,upperThreshold:a}=void 0===e?{}:e;if(r>a)throw new Error("thresholds invalid");var t=(e,r,a)=>e<r||e>a;return this.generateSeries({raw:e=>t(e.value,r,a)?e.value:null,flag:e=>t(e.value,r,a)?["outlier"]:null}).transformSeries({value:e=>t(e,r,a)?null:e})}reset(){return this.withSeries({value:e=>e.raw&&!isNaN(e.raw)?e.raw:e.value}).dropSeries(["flag","raw"])}group(e,a){if(-1===["hour","day","month","year"].indexOf(e))throw new Error("interval type not supported");return this.groupBy(a=>r(a.date).startOf(e))}resample(e,t){var[n,i=1]=e;if(-1===["hour","day","month","year"].indexOf(n))throw new Error("interval type not supported");var o=this.interval;if(a(o,[n,i]))return this;var l=r(0);return r(0).add(o[1],o[0]).diff(l)<r(0).add(i,n).diff(l)?this.downsample([n,i],t):this.upsample([n,i],t)}upsample(e,r){var[a,t]=e;return void 0===r&&(r="avg"),this.fillGaps(u([a,t]),v(r,[a,t]))}downsample(e,a){var[n,i]=e;if(void 0===a&&(a="sum"),-1===["hour","day","month","year"].indexOf(n))throw new Error("interval type not supported");if(-1===["sum","avg","median"].indexOf(a))throw new Error("aggregation type not suppported, only:");var o=e=>r(e.date).startOf(n);return i&&(o=e=>r(e.date).startOf(n).add(i,n)),this.groupBy(o).select(e=>l({date:r(e.first().date).startOf(n).toDate()},t(e.getColumnNames().filter(e=>"date"!==e).map(r=>{var t;switch(a){case"median":t=e.deflate(e=>e[r]).median();break;case"avg":t=e.deflate(e=>e[r]).average();break;default:t=e.deflate(e=>e[r]).sum()}return[r,t]})))).inflate().withIndex(e=>e.date.valueOf())}calculateStatistics(e){var{column:r="value",filterZeros:a=!1,filterNegative:t=!0}=void 0===e?{}:e,n=this.deflate(e=>e[columnName]).where(e=>!isNaN(e));t&&(n=n.where(e=>e>=0)),a&&(n=n.where(e=>0!==e));var l=n.median(),s=n.average(),u=n.count(),d=n.std(),f=n.min(),v=n.max(),h=i(n.toArray()),p=o(n.toArray(),.25),m=o(n.toArray(),.75);return{median:l,mean:s,count:u,std:d,min:f,max:v,mad:h,q1:p,q3:m,iqr:m-p}}dataQuality(){return this.count(),this.getSeries("flag").where(e=>null==e||Array.isArray(e)&&0===e.length).count(),this.getSeries("flag").where(e=>Array.isArray(e)).where(e=>-1!==e.indexOf("missing")).count(),this.getSeries("flag").where(e=>Array.isArray(e)).where(e=>-1!==e.indexOf("outlier")).count(),this.getSeries("flag").where(e=>Array.isArray(e)).where(e=>-1!==e.indexOf("zeroFill")).count(),{}}populate(e,r){var a;switch(void 0===r&&(r="avg"),r){case"fill":a=e;break;default:a=e/this.getIndex().count()}return this.generateSeries({value:e=>a})}fill(e,r){e&&Array.isArray(e)||(e=this.interval);var a=this.fillGaps(u(e),v(r,e));return new h(a)}reduceToValue(e){var r=this.generateSeries({value:r=>(function(e,r){return void 0===r&&(r=[]),r.map(r=>e[r]).filter(e=>e)[0]||0})(r,e)}).subset(["date","value"]);return new h(r)}clean(e,r){void 0===e&&(e="value");var{lowerThreshold:a,upperThreshold:t}=r,n=this.toArray().map(r=>{var n=r[e];return n>t||n<a?l({},r,{value:void 0,raw:n}):r});return new h(n)}static blank(e,r,a){var[t,n=1]=a;if(["minute","hour","day","month","year"].indexOf(t)<0)throw console.error(interval),new Error("interval type not supported");var i=new h([{date:new Date(e)},{date:new Date(r)}]).fillGaps(u([t,n]),d([t,n])).between(e,r);return new h(i)}static aggregate(r){Array.isArray(r)||(r=[r]),r=r.map(e=>new h(e));var a=e.concat(r).groupBy(e=>e.date).select(e=>{var r={date:e.first().date};return e.getColumnNames().filter(e=>"date"!==e).forEach(a=>r[a]=e.deflate(e=>e[a]).sum()),r}).inflate().toArray();return new h(a)}annualMonthlyAverage(e){var{startDate:r,endDate:a}=e;this.downsample(["month",1],"sum").between(r,a).getSeries("value").average()}}export default h;
//# sourceMappingURL=index.modern.js.map
